/**
 * OSD Font Renderer
 *
 * Generates pixel-art OSD character glyphs matching the ArduPilot MAX7456
 * "Clarity" font style. Each glyph is 12×18 pixels (standard MAX7456 cell).
 *
 * For HD resolutions, glyphs are scaled 2x (24×36) to maintain readability.
 *
 * The renderer draws to an offscreen canvas and caches sprite sheets for
 * fast blitting during preview rendering.
 */

import { SYM } from '@/models/osdElements';

// ─── Constants ───────────────────────────────────────────────────────────────

/** MAX7456 character cell dimensions */
export const CHAR_W = 12;
export const CHAR_H = 18;

/** Colors matching typical OSD output */
const WHITE = '#FFFFFF';
const BLACK = '#000000';
const OUTLINE = '#1A1A1A'; // Dark outline for contrast

// ─── Pixel drawing helpers ───────────────────────────────────────────────────

type PixelGrid = (0 | 1 | 2)[][]; // 0=transparent, 1=white, 2=outline/dark

// ─── Symbol glyph definitions (12×18 pixel art) ─────────────────────────────
// Each is a simplified but recognizable icon at MAX7456 resolution.
// Grid rows from top to bottom, columns left to right.
// Using shorthand: W=1 (white), D=2 (dark/outline), _=0 (transparent)

const _ = 0, W = 1;

const SYMBOL_GLYPHS: Record<string, PixelGrid> = {
  // ⚡ Battery voltage icon -- lightning bolt
  [SYM.VOLT]: [
    [_,_,_,_,_,W,W,_,_,_,_,_],
    [_,_,_,_,W,W,_,_,_,_,_,_],
    [_,_,_,W,W,_,_,_,_,_,_,_],
    [_,_,W,W,_,_,_,_,_,_,_,_],
    [_,W,W,W,W,W,W,_,_,_,_,_],
    [_,_,_,_,_,W,W,_,_,_,_,_],
    [_,_,_,_,W,W,_,_,_,_,_,_],
    [_,_,_,W,W,_,_,_,_,_,_,_],
    [_,_,W,W,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
  ],

  // Current draw icon -- A with arrow
  [SYM.CURR]: [
    [_,_,_,_,_,W,_,_,_,_,_,_],
    [_,_,_,_,W,W,W,_,_,_,_,_],
    [_,_,_,W,W,_,W,W,_,_,_,_],
    [_,_,W,W,_,_,_,W,W,_,_,_],
    [_,_,W,W,W,W,W,W,W,_,_,_],
    [_,_,W,W,_,_,_,W,W,_,_,_],
    [_,_,W,W,_,_,_,W,W,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
  ],

  // mAh icon -- battery outline
  [SYM.MAH]: [
    [_,_,_,W,W,W,W,W,W,_,_,_],
    [_,_,W,W,W,W,W,W,W,W,_,_],
    [_,W,W,_,_,_,_,_,_,W,W,_],
    [_,W,W,_,_,_,_,_,_,W,W,_],
    [W,W,W,_,_,_,_,_,_,W,W,W],
    [W,W,W,_,_,_,_,_,_,W,W,W],
    [_,W,W,_,_,_,_,_,_,W,W,_],
    [_,W,W,W,W,W,W,W,W,W,W,_],
    [_,_,W,W,W,W,W,W,W,W,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
  ],

  // Altitude icon -- mountain/triangle
  [SYM.ALT]: [
    [_,_,_,_,_,W,_,_,_,_,_,_],
    [_,_,_,_,W,W,W,_,_,_,_,_],
    [_,_,_,W,W,_,W,W,_,_,_,_],
    [_,_,W,W,_,_,_,W,W,_,_,_],
    [_,W,W,_,_,_,_,_,W,W,_,_],
    [W,W,_,_,_,W,_,_,_,W,W,_],
    [W,W,_,_,W,W,W,_,_,W,W,_],
    [W,W,W,W,W,W,W,W,W,W,W,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
  ],

  // Satellite icon
  [SYM.SAT]: [
    [_,_,_,_,_,_,_,_,_,W,W,_],
    [_,_,_,_,_,_,_,W,W,W,_,_],
    [_,_,_,_,_,_,W,W,W,_,_,_],
    [_,_,_,_,_,W,W,W,_,_,_,_],
    [_,W,W,_,W,W,W,_,_,_,_,_],
    [_,W,W,W,W,W,_,_,_,_,_,_],
    [_,_,W,W,W,_,_,_,_,_,_,_],
    [_,_,_,W,W,W,_,_,_,_,_,_],
    [_,_,_,_,W,W,W,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
  ],

  // Speed icon -- right-pointing arrow
  [SYM.SPEED]: [
    [_,_,_,_,W,_,_,_,_,_,_,_],
    [_,_,_,_,W,W,_,_,_,_,_,_],
    [W,W,W,W,W,W,W,_,_,_,_,_],
    [W,W,W,W,W,W,W,W,_,_,_,_],
    [W,W,W,W,W,W,W,_,_,_,_,_],
    [_,_,_,_,W,W,_,_,_,_,_,_],
    [_,_,_,_,W,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
  ],

  // Home icon -- house shape
  [SYM.HOME]: [
    [_,_,_,_,_,W,_,_,_,_,_,_],
    [_,_,_,_,W,W,W,_,_,_,_,_],
    [_,_,_,W,W,W,W,W,_,_,_,_],
    [_,_,W,W,W,W,W,W,W,_,_,_],
    [_,W,W,W,W,W,W,W,W,W,_,_],
    [_,W,W,_,_,_,_,_,W,W,_,_],
    [_,W,W,_,W,W,W,_,W,W,_,_],
    [_,W,W,_,W,W,W,_,W,W,_,_],
    [_,W,W,_,W,W,W,_,W,W,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
  ],

  // Distance icon -- double arrow
  [SYM.DIST]: [
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,W,_,_,_,_,_,_,W,_,_,_],
    [_,W,W,_,_,_,_,W,W,_,_,_],
    [_,W,W,W,W,W,W,W,W,_,_,_],
    [_,W,W,_,_,_,_,W,W,_,_,_],
    [_,W,_,_,_,_,_,_,W,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
  ],

  // Vertical speed icon -- up/down arrows
  [SYM.VSPEED]: [
    [_,_,_,_,_,W,_,_,_,_,_,_],
    [_,_,_,_,W,W,W,_,_,_,_,_],
    [_,_,_,W,_,W,_,W,_,_,_,_],
    [_,_,_,_,_,W,_,_,_,_,_,_],
    [_,_,_,_,_,W,_,_,_,_,_,_],
    [_,_,_,_,_,W,_,_,_,_,_,_],
    [_,_,_,W,_,W,_,W,_,_,_,_],
    [_,_,_,_,W,W,W,_,_,_,_,_],
    [_,_,_,_,_,W,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
  ],

  // Throttle icon -- gauge
  [SYM.THROTTLE]: [
    [_,_,_,W,W,W,W,W,_,_,_,_],
    [_,_,W,W,_,_,_,W,W,_,_,_],
    [_,W,W,_,_,_,_,_,W,W,_,_],
    [_,W,W,_,_,_,_,W,W,W,_,_],
    [_,W,W,_,_,_,W,W,_,W,_,_],
    [_,W,W,_,_,W,W,_,_,W,_,_],
    [_,_,W,W,_,_,_,_,W,W,_,_],
    [_,_,_,W,W,W,W,W,W,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
  ],

  // Heading icon -- compass needle
  [SYM.HEADING]: [
    [_,_,_,_,_,W,_,_,_,_,_,_],
    [_,_,_,_,W,W,W,_,_,_,_,_],
    [_,_,_,W,W,W,W,W,_,_,_,_],
    [_,_,_,_,_,W,_,_,_,_,_,_],
    [_,_,_,_,_,W,_,_,_,_,_,_],
    [_,_,_,_,_,W,_,_,_,_,_,_],
    [_,_,_,_,_,W,_,_,_,_,_,_],
    [_,_,_,_,_,W,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
  ],

  // Wind icon -- wavy lines
  [SYM.WIND]: [
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,W,_,W,_,W,_,W,_,W,_,_],
    [W,_,W,_,W,_,W,_,W,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,W,_,W,_,W,_,W,_,W,_,_],
    [W,_,W,_,W,_,W,_,W,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
  ],

  // Airspeed icon -- pitot tube / airflow
  [SYM.ASPEED]: [
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,W,W,W,W,W,_,_,_,_,_],
    [_,W,_,_,_,_,_,W,W,W,_,_],
    [W,_,_,_,_,_,_,_,_,W,W,_],
    [_,W,_,_,_,_,_,W,W,W,_,_],
    [_,_,W,W,W,W,W,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
  ],

  // RSSI icon -- signal bars
  [SYM.RSSI]: [
    [_,_,_,_,_,_,_,_,_,W,W,_],
    [_,_,_,_,_,_,_,W,W,W,W,_],
    [_,_,_,_,_,W,W,W,W,W,W,_],
    [_,_,_,W,W,W,W,W,W,W,W,_],
    [_,W,W,W,W,W,W,W,W,W,W,_],
    [W,W,W,W,W,W,W,W,W,W,W,_],
    [W,W,W,W,W,W,W,W,W,W,W,_],
    [W,W,W,W,W,W,W,W,W,W,W,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
  ],

  // Flight mode icon -- F with bar
  [SYM.FLTMODE]: [
    [_,W,W,W,W,W,W,W,W,_,_,_],
    [_,W,W,_,_,_,_,_,_,_,_,_],
    [_,W,W,_,_,_,_,_,_,_,_,_],
    [_,W,W,W,W,W,W,_,_,_,_,_],
    [_,W,W,_,_,_,_,_,_,_,_,_],
    [_,W,W,_,_,_,_,_,_,_,_,_],
    [_,W,W,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
  ],

  // Cell voltage icon -- single cell
  [SYM.CELL]: [
    [_,_,_,_,W,W,_,_,_,_,_,_],
    [_,_,W,W,W,W,W,W,_,_,_,_],
    [_,_,W,W,_,_,W,W,_,_,_,_],
    [_,_,W,W,_,_,W,W,_,_,_,_],
    [_,_,W,W,_,_,W,W,_,_,_,_],
    [_,_,W,W,_,_,W,W,_,_,_,_],
    [_,_,W,W,W,W,W,W,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
  ],

  // Temperature icon -- thermometer
  [SYM.TEMP]: [
    [_,_,_,_,_,W,_,_,_,_,_,_],
    [_,_,_,_,W,_,W,_,_,_,_,_],
    [_,_,_,_,W,_,W,_,_,_,_,_],
    [_,_,_,_,W,W,W,_,_,_,_,_],
    [_,_,_,_,W,W,W,_,_,_,_,_],
    [_,_,_,W,W,W,W,W,_,_,_,_],
    [_,_,_,W,W,W,W,W,_,_,_,_],
    [_,_,_,_,W,W,W,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
  ],

  // Efficiency icon -- leaf / energy
  [SYM.EFF]: [
    [_,_,_,_,_,_,W,W,W,_,_,_],
    [_,_,_,_,W,W,W,W,_,_,_,_],
    [_,_,_,W,W,W,_,_,_,_,_,_],
    [_,_,W,W,W,_,_,_,_,_,_,_],
    [_,W,W,W,W,_,_,_,_,_,_,_],
    [_,_,W,W,W,W,_,_,_,_,_,_],
    [_,_,_,W,W,W,W,_,_,_,_,_],
    [_,_,_,_,W,W,W,W,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
  ],

  // Link quality icon -- chain link
  [SYM.LQ]: [
    [_,_,_,_,W,W,W,_,_,_,_,_],
    [_,_,_,W,_,_,_,W,_,_,_,_],
    [_,_,W,_,_,_,_,_,W,_,_,_],
    [_,_,W,_,_,_,_,_,W,_,_,_],
    [_,_,_,W,_,_,_,W,_,_,_,_],
    [_,_,_,_,W,W,W,_,_,_,_,_],
    [_,_,_,_,W,W,W,_,_,_,_,_],
    [_,_,_,W,_,_,_,W,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
  ],

  // Crosshair
  [SYM.CROSSHAIR]: [
    [_,_,_,_,_,W,_,_,_,_,_,_],
    [_,_,_,_,_,W,_,_,_,_,_,_],
    [_,_,_,_,_,W,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [W,W,W,_,_,_,_,_,W,W,W,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,W,_,_,_,_,_,_],
    [_,_,_,_,_,W,_,_,_,_,_,_],
    [_,_,_,_,_,W,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
  ],

  // Waypoint icon -- diamond
  [SYM.WAYPOINT]: [
    [_,_,_,_,_,W,_,_,_,_,_,_],
    [_,_,_,_,W,W,W,_,_,_,_,_],
    [_,_,_,W,W,W,W,W,_,_,_,_],
    [_,_,W,W,W,W,W,W,W,_,_,_],
    [_,_,_,W,W,W,W,W,_,_,_,_],
    [_,_,_,_,W,W,W,_,_,_,_,_],
    [_,_,_,_,_,W,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
  ],

  // Cross-track error icon -- path deviation
  [SYM.XTRACK]: [
    [_,_,_,_,_,W,_,_,_,_,_,_],
    [_,_,_,_,_,W,_,_,_,_,_,_],
    [_,_,_,_,_,W,_,_,_,_,_,_],
    [_,_,_,_,_,W,_,_,_,_,_,_],
    [_,_,_,_,_,W,_,_,_,_,_,_],
    [_,_,_,_,_,W,_,W,_,_,_,_],
    [_,_,_,_,_,W,W,_,_,_,_,_],
    [_,_,_,_,W,W,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
  ],

  // Terrain altitude icon -- bumpy ground
  [SYM.TERRAIN]: [
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,W,_,_,_,_,_,_,_,_],
    [_,_,W,W,W,_,_,_,W,_,_,_],
    [_,W,W,_,W,W,_,W,W,W,_,_],
    [W,W,_,_,_,W,W,W,_,W,W,_],
    [W,_,_,_,_,_,W,_,_,_,W,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
  ],

  // Clock / timer icon
  [SYM.CLK]: [
    [_,_,_,W,W,W,W,_,_,_,_,_],
    [_,_,W,_,_,_,_,W,_,_,_,_],
    [_,W,_,_,_,W,_,_,W,_,_,_],
    [_,W,_,_,_,W,_,_,W,_,_,_],
    [_,W,_,_,_,W,W,W,W,_,_,_],
    [_,W,_,_,_,_,_,_,W,_,_,_],
    [_,_,W,_,_,_,_,W,_,_,_,_],
    [_,_,_,W,W,W,W,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
  ],

  // RPM icon -- circular arrow
  [SYM.RPM]: [
    [_,_,_,W,W,W,W,_,_,_,_,_],
    [_,_,W,_,_,_,_,W,W,_,_,_],
    [_,W,_,_,_,_,_,W,_,_,_,_],
    [_,W,_,_,_,_,_,_,_,_,_,_],
    [_,W,_,_,_,_,_,_,W,_,_,_],
    [_,_,W,_,_,_,_,W,_,_,_,_],
    [_,_,_,W,W,W,W,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
  ],

  // Power icon -- lightning in circle
  [SYM.POWER]: [
    [_,_,_,W,W,W,W,_,_,_,_,_],
    [_,_,W,_,_,W,_,W,_,_,_,_],
    [_,W,_,_,W,W,_,_,W,_,_,_],
    [_,W,_,W,W,W,W,_,W,_,_,_],
    [_,W,_,_,_,W,W,_,W,_,_,_],
    [_,_,W,_,W,W,_,W,_,_,_,_],
    [_,_,_,W,W,W,W,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
    [_,_,_,_,_,_,_,_,_,_,_,_],
  ],
};

// For unit/misc symbols, we'll use simple text fallbacks
// mapped to the same private-use-area codes
const TEXT_FALLBACK_SYMBOLS: Record<string, string> = {
  [SYM.UNIT_M]: 'm',
  [SYM.UNIT_KMH]: 'km/h',
  [SYM.UNIT_V]: 'V',
  [SYM.UNIT_A]: 'A',
  [SYM.UNIT_MS]: 'm/s',
  [SYM.GPS]: 'GPS',
  [SYM.HORIZON_L]: '─',
  [SYM.HORIZON_R]: '─',
  [SYM.BATT_FULL]: '█',
  [SYM.BATT_EMPTY]: '░',
  [SYM.ARROW_UP]: '↑',
  [SYM.ARROW_DN]: '↓',
  [SYM.COMPASS_N]: 'N',
  [SYM.COMPASS_S]: 'S',
  [SYM.COMPASS_E]: 'E',
  [SYM.COMPASS_W]: 'W',
};

// ─── ASCII character pixel data ──────────────────────────────────────────────
// Compact 5×7 bitmap font for alphanumeric characters, rendered inside the
// 12×18 cell with 1px outline for OSD contrast.

// ─── Font Renderer Class ─────────────────────────────────────────────────────

export class OsdFontRenderer {
  constructor() {
    // Renderer is now stateless -- scaling is handled per-call via cellW/cellH
  }

  /**
   * Render a single character to the target canvas context.
   * cellW/cellH are the actual pixel dimensions of one character cell on screen.
   */
  renderChar(
    ctx: CanvasRenderingContext2D,
    char: string,
    x: number,
    y: number,
    cellW: number,
    cellH: number
  ): void {
    const codePoint = char.codePointAt(0) || 0;

    // Check if it's a symbol glyph (private use area U+E000-E0FF)
    if (codePoint >= 0xE000 && codePoint <= 0xE0FF) {
      const glyph = SYMBOL_GLYPHS[char];
      if (glyph) {
        this.renderPixelGlyph(ctx, glyph, x, y, cellW, cellH);
        return;
      }

      // Check text fallbacks for unit symbols
      const fallback = TEXT_FALLBACK_SYMBOLS[char];
      if (fallback) {
        for (let i = 0; i < fallback.length; i++) {
          this.renderAsciiChar(ctx, fallback[i], x + i * cellW, y, cellW, cellH);
        }
        return;
      }

      this.renderAsciiChar(ctx, '?', x, y, cellW, cellH);
      return;
    }

    this.renderAsciiChar(ctx, char, x, y, cellW, cellH);
  }

  /**
   * Render a complete OSD element preview string at a grid position.
   * Returns the total width in pixels consumed.
   */
  renderString(
    ctx: CanvasRenderingContext2D,
    text: string,
    gridX: number,
    gridY: number,
    cellW: number,
    cellH: number
  ): number {
    let pixelX = gridX * cellW;
    const pixelY = gridY * cellH;
    let charsRendered = 0;

    const chars = [...text]; // Proper Unicode iteration
    for (const char of chars) {
      const codePoint = char.codePointAt(0) || 0;

      // Check if symbol has a multi-char text fallback
      if (codePoint >= 0xE000 && codePoint <= 0xE0FF) {
        const fallback = TEXT_FALLBACK_SYMBOLS[char];
        if (fallback && !SYMBOL_GLYPHS[char]) {
          for (const fc of fallback) {
            this.renderAsciiChar(ctx, fc, pixelX, pixelY, cellW, cellH);
            pixelX += cellW;
            charsRendered++;
          }
          continue;
        }
      }

      this.renderChar(ctx, char, pixelX, pixelY, cellW, cellH);
      pixelX += cellW;
      charsRendered++;
    }

    return charsRendered;
  }

  /**
   * Render a pixel-art glyph from a PixelGrid, scaled to fill the cell.
   * Grid is 12×18; each grid pixel maps to (cellW/12 × cellH/18) canvas pixels.
   */
  private renderPixelGlyph(
    ctx: CanvasRenderingContext2D,
    grid: PixelGrid,
    x: number,
    y: number,
    cellW: number,
    cellH: number
  ): void {
    const sx = cellW / CHAR_W;  // scale factor X
    const sy = cellH / CHAR_H;  // scale factor Y

    // Draw dark outline first (1px border around white pixels)
    ctx.fillStyle = OUTLINE;
    for (let gy = 0; gy < grid.length; gy++) {
      for (let gx = 0; gx < grid[gy].length; gx++) {
        if (grid[gy][gx] === 1) {
          for (let dy = -1; dy <= 1; dy++) {
            for (let dx = -1; dx <= 1; dx++) {
              if (dx === 0 && dy === 0) continue;
              ctx.fillRect(
                x + (gx + dx) * sx,
                y + (gy + dy) * sy,
                sx,
                sy
              );
            }
          }
        }
      }
    }

    // Draw white pixels on top
    for (let gy = 0; gy < grid.length; gy++) {
      for (let gx = 0; gx < grid[gy].length; gx++) {
        if (grid[gy][gx] === 1) {
          ctx.fillStyle = WHITE;
          ctx.fillRect(x + gx * sx, y + gy * sy, sx, sy);
        } else if (grid[gy][gx] === 2) {
          ctx.fillStyle = OUTLINE;
          ctx.fillRect(x + gx * sx, y + gy * sy, sx, sy);
        }
      }
    }
  }

  /** Render an ASCII character with OSD-style outline, scaled to cell size */
  private renderAsciiChar(
    ctx: CanvasRenderingContext2D,
    char: string,
    x: number,
    y: number,
    cellW: number,
    cellH: number
  ): void {
    const fontSize = Math.max(8, cellH * 0.65);

    ctx.font = `bold ${fontSize}px "Courier New", monospace`;
    ctx.textBaseline = 'top';
    ctx.textAlign = 'left';

    // Offset to center text within the cell
    const offsetX = cellW * 0.08;
    const offsetY = cellH * 0.12;

    // Black outline -- draw in 8 directions
    const outlineOffset = Math.max(0.8, cellH * 0.04);
    ctx.fillStyle = BLACK;
    for (let dy = -outlineOffset; dy <= outlineOffset; dy += outlineOffset) {
      for (let dx = -outlineOffset; dx <= outlineOffset; dx += outlineOffset) {
        if (dx === 0 && dy === 0) continue;
        ctx.fillText(char, x + dx + offsetX, y + dy + offsetY);
      }
    }

    // White fill
    ctx.fillStyle = WHITE;
    ctx.fillText(char, x + offsetX, y + offsetY);
  }
}

// ─── Shared instance ─────────────────────────────────────────────────────────

let sharedRenderer: OsdFontRenderer | null = null;

/** Get the shared font renderer instance */
export function getOsdFontRenderer(): OsdFontRenderer {
  if (!sharedRenderer) sharedRenderer = new OsdFontRenderer();
  return sharedRenderer;
}
